# System Czatu/Wiadomo≈õci - PetHelp

## üí¨ PrzeglƒÖd Systemu

System czatu PetHelp umo≈ºliwia bezpiecznƒÖ komunikacjƒô miƒôdzy w≈Ça≈õcicielami zwierzƒÖt a opiekunami. Wiadomo≈õci sƒÖ organizowane w konwersacje, mogƒÖ byƒá powiƒÖzane z konkretnƒÖ rezerwacjƒÖ i obs≈ÇugujƒÖ za≈ÇƒÖczniki.

## üéØ Kluczowe Funkcjonalno≈õci

### Komunikacja
- **Prywatne rozmowy** - 1-na-1 miƒôdzy w≈Ça≈õcicielem a opiekunem
- **Kontekst rezerwacji** - Rozmowy mogƒÖ byƒá powiƒÖzane z konkretnƒÖ rezerwacjƒÖ
- **Za≈ÇƒÖczniki** - Obs≈Çuga zdjƒôƒá i plik√≥w (max 10MB)
- **Oznaczanie jako przeczytane** - Tracking nieprzeczytanych wiadomo≈õci
- **Edycja wiadomo≈õci** - 15-minutowe okno na edycjƒô
- **Soft delete** - Usuwanie wiadomo≈õci (tylko dla wysy≈ÇajƒÖcego)

### Organizacja Konwersacji
- **Lista rozm√≥w** - Sortowana wed≈Çug ostatniej aktywno≈õci
- **Liczniki nieprzeczytanych** - Na poziomie rozmowy i globalnie
- **Automatyczne tworzenie** - Rozmowy tworzƒÖ siƒô przy pierwszej wiadomo≈õci
- **Unikalno≈õƒá** - Jedna rozmowa miƒôdzy u≈ºytkownikami per rezerwacja

## üèóÔ∏è Architektura Techniczna

### Modele Danych

#### Conversation Model
```php
// app/Models/Conversation.php
- owner_id_id, sitter_id_id (uporzƒÖdkowane ID u≈ºytkownik√≥w)
- booking_id (opcjonalne powiƒÖzanie z rezerwacjƒÖ)  
- subject (temat rozmowy)
- last_message_at (timestamp ostatniej wiadomo≈õci)
```

**Kluczowe Metody:**
- `getOtherUser(User $user)` - Zwraca drugiego uczestnika
- `hasUser(User $user)` - Sprawdza czy user uczestniczy
- `findOrCreateBetweenUsers()` - Znajd≈∫/utw√≥rz rozmowƒô
- `markAsReadForUser()` - Oznacz wszystkie jako przeczytane

#### Message Model  
```php
// app/Models/Message.php
- conversation_id (powiƒÖzanie z rozmowƒÖ)
- sender_id (kto wys≈Ça≈Ç)
- content (tre≈õƒá wiadomo≈õci)
- type (text/image/file)
- attachment_path, attachment_name (za≈ÇƒÖczniki)
- read_at (timestamp przeczytania)
- edited_at (timestamp edycji)
- is_deleted (soft delete)
```

**Kluczowe Metody:**
- `markAsRead()` - Oznacz jako przeczytane
- `markAsEdited()` - Oznacz jako edytowane  
- `softDelete()` - Usu≈Ñ (soft delete)
- `hasAttachment()` - Sprawd≈∫ czy ma za≈ÇƒÖcznik
- `getAttachmentSizeAttribute()` - Rozmiar pliku

### Kontroler API

#### MessageController
```php
// app/Http/Controllers/MessageController.php

GET    /conversations          # Lista rozm√≥w u≈ºytkownika
GET    /conversations/{id}/messages  # Wiadomo≈õci w rozmowie
POST   /conversations/{id}/messages  # Wy≈õlij wiadomo≈õƒá
POST   /conversations/start   # Rozpocznij nowƒÖ rozmowƒô
PUT    /messages/{id}         # Edytuj wiadomo≈õƒá (15min)
DELETE /messages/{id}         # Usu≈Ñ wiadomo≈õƒá
POST   /conversations/{id}/read  # Oznacz jako przeczytane
GET    /messages/unread-count # Liczba nieprzeczytanych
```

### Bezpiecze≈Ñstwo i Autoryzacja

#### Zabezpieczenia
- **Autoryzacja** - Tylko uczestnicy rozmowy majƒÖ dostƒôp
- **Walidacja booking** - Sprawdzanie uprawnie≈Ñ do rezerwacji
- **Self-messaging** - Blokada wysy≈Çania do siebie
- **File upload** - Ograniczenia rozmiaru i typu plik√≥w
- **Time limits** - 15min na edycjƒô wiadomo≈õci

#### Rate Limiting
- Upload plik√≥w: 10MB max
- D≈Çugo≈õƒá wiadomo≈õci: 5000 znak√≥w max
- Batch operations: Paginacja 20/50 element√≥w

## üíæ Struktura Bazy Danych

### Tabela `conversations`
```sql
- id (Primary Key)
- owner_id_id (Foreign Key -> users.id) 
- sitter_id_id (Foreign Key -> users.id)
- booking_id (Foreign Key -> bookings.id, nullable)
- subject (varchar, nullable)
- last_message_at (timestamp, nullable)
- created_at, updated_at

UNIQUE KEY (owner_id_id, sitter_id_id, booking_id)
INDEX (owner_id_id, sitter_id_id)
```

### Tabela `messages` 
```sql
- id (Primary Key)
- conversation_id (Foreign Key -> conversations.id)
- sender_id (Foreign Key -> users.id)
- content (text)
- type (enum: text, image, file)
- attachment_path (varchar, nullable)
- attachment_name (varchar, nullable)  
- read_at (timestamp, nullable)
- edited_at (timestamp, nullable)
- is_deleted (boolean, default false)
- created_at, updated_at

INDEX (conversation_id, created_at)
INDEX (sender_id, created_at)  
INDEX (read_at)
```

## üîÑ Integracje z Systemem

### User Model Extensions
```php
// app/Models/User.php
- getAllConversations() # Lista rozm√≥w u≈ºytkownika
- getUnreadMessagesCount() # Liczba nieprzeczytanych wiadomo≈õci
- sentMessages() # Relacja do wys≈Çanych wiadomo≈õci
```

### Automatic Updates
- **last_message_at** - Automatyczna aktualizacja przy nowej wiadomo≈õci
- **Conversation creation** - Auto-tworzenie przy pierwszej wiadomo≈õci
- **File cleanup** - TODO: Cleanup unused attachment files

## üì± Funkcjonalno≈õci U≈ºytkownika

### Lista Rozm√≥w
- Sortowanie wed≈Çug ostatniej aktywno≈õci
- PodglƒÖd ostatniej wiadomo≈õci
- Liczniki nieprzeczytanych wiadomo≈õci
- Informacje o powiƒÖzanej rezerwacji
- Avatar i nazwa rozm√≥wcy

### Widok Rozmowy
- **Scroll do najnowszych** - Automatyczne przewijanie
- **Message bubbles** - R√≥≈ºne style dla w≈Çasnych/obcych wiadomo≈õci  
- **Timestamps** - Czytelne daty i czasy
- **Read receipts** - Status przeczytania
- **Edit indicators** - Oznaczenie edytowanych wiadomo≈õci
- **Attachment previews** - PodglƒÖd zdjƒôƒá, download plik√≥w

### Wysy≈Çanie Wiadomo≈õci
- **Auto-resize textarea** - RozszerzajƒÖce siƒô pole tekstowe
- **File upload** - Drag&drop lub click to upload
- **Send shortcuts** - Enter to send (Shift+Enter = nowa linia)
- **Typing indicators** - TODO: Real-time typing status
- **Emoji support** - Wsparcie dla emoji w wiadomo≈õciach

## üé® Frontend (Do Implementacji)

### Komponenty Vue.js

#### ConversationList.vue
```vue
// Lista rozm√≥w u≈ºytkownika
- Infinite scroll dla du≈ºych list
- Search/filter rozm√≥w  
- Unread badges
- Context menu (archive, delete)
- Real-time updates
```

#### MessageChat.vue  
```vue
// G≈Ç√≥wny komponent rozmowy
- Message history z lazy loading
- Real-time message updates
- Scroll to bottom functionality
- Message status indicators
- File preview modals
```

#### MessageInput.vue
```vue 
// Input do wysy≈Çania wiadomo≈õci
- Auto-expanding textarea
- File upload progress
- Emoji picker
- Send button states
- Draft saving (localStorage)
```

#### MessageBubble.vue
```vue
// Pojedyncza wiadomo≈õƒá
- Different styles for own/other messages
- Timestamp formatting  
- Edit/delete context menu
- Attachment rendering
- Read status display
```

### Ruty Frontend
```javascript
// resources/js/Pages/
- Messages.vue         # G≈Ç√≥wna strona wiadomo≈õci
- MessageThread.vue    # Konkretna rozmowa

// URL Routes  
/messages              # Lista rozm√≥w
/messages/{id}         # Konkretna rozmowa
```

## üîî Integracja z Powiadomieniami

### Powiadomienia Email (Do Implementacji)
```php
// app/Notifications/NewMessageNotification.php
- Email notification dla nowych wiadomo≈õci
- Batch notifications (nie spam dla ka≈ºdej wiadomo≈õci)
- Unsubscribe options w email settings
```

### Real-time Updates (Do Implementacji)
```javascript
// WebSockets lub Server-Sent Events
- New message notifications
- Typing indicators
- Online status
- Message read receipts
```

## ‚ö° Performance i Optymalizacja

### Database Indexing
- Composite index na (conversation_id, created_at) dla messages
- Index na read_at dla szybkich zapyta≈Ñ o nieprzeczytane
- Index na (owner_id_id, sitter_id_id) dla conversations

### Caching Strategy
```php
// Redis caching dla aktywnych rozm√≥w
- Cache user conversation lists
- Cache unread counts  
- Cache recent messages per conversation
- Invalidation na message create/update
```

### File Storage
- Storage w `storage/app/public/messages/`
- Unique filenames zapobiegajƒÖ kolizjom
- TODO: CDN integration dla du≈ºego ruchu
- TODO: Auto-cleanup starych plik√≥w

## üß™ Testing Strategy

### Unit Tests
```php
// tests/Unit/Models/
ConversationTest.php   # Test model methods
MessageTest.php        # Test message operations
UserMessagingTest.php  # Test user integrations
```

### Feature Tests  
```php
// tests/Feature/
MessageControllerTest.php     # API endpoints
ConversationFlowTest.php      # Complete user flows
FileUploadTest.php           # Attachment handling
AuthorizationTest.php        # Security testing
```

### Frontend Testing
```javascript
// tests/js/
MessageComponents.test.js     # Vue component tests
MessageIntegration.test.js    # E2E conversation flows
```

## üöÄ Deployment Considerations

### Production Setup
- **Queue Workers** - Background processing dla file operations
- **File Storage** - S3/CloudFlare dla attachments w production  
- **Database** - Connection pooling dla concurrent users
- **Monitoring** - Logging message volume i performance metrics

### Scaling
- **Horizontal scaling** - Sharding conversations per user_id
- **Message archiving** - Move old messages to cold storage
- **CDN** - Serve static attachments via CDN
- **WebSocket servers** - Separate real-time infrastructure

---

## ‚úÖ Status Implementacji

### ‚úÖ UKO≈ÉCZONE (Backend):
- [x] Database schema (conversations, messages tables)
- [x] Conversation model z business logic
- [x] Message model z attachment support
- [x] MessageController z pe≈Çnym API
- [x] User model integration
- [x] Authorization i security
- [x] File upload handling
- [x] Soft delete functionality
- [x] Read status tracking
- [x] Message editing (15min window)

### üîÑ DO IMPLEMENTACJI (Frontend):
- [ ] Vue.js components (ConversationList, MessageChat, MessageInput)
- [ ] API routes w web.php
- [ ] Strona Messages.vue
- [ ] Real-time updates (polling/WebSockets)
- [ ] File upload UI z progress
- [ ] Message notifications integration
- [ ] Responsive design dla mobile
- [ ] Emoji picker
- [ ] Message search functionality

### üéØ PRZYSZ≈ÅE ROZSZERZENIA:
- [ ] Typing indicators
- [ ] Voice messages
- [ ] Video calls integration
- [ ] Message reactions (thumbs up, heart)
- [ ] Group conversations (multiple users)
- [ ] Message templates/quick replies
- [ ] Conversation archiving
- [ ] Advanced search w wiadomo≈õciach

**Backend systemu czatu jest w pe≈Çni funkcjonalny i gotowy do integracji z frontendem! üéâ**

G≈Ç√≥wne funkcje:
- ‚úÖ Bezpieczna komunikacja 1-na-1
- ‚úÖ PowiƒÖzanie z rezerwacjami
- ‚úÖ Za≈ÇƒÖczniki (zdjƒôcia/pliki)  
- ‚úÖ Oznaczanie jako przeczytane
- ‚úÖ Edycja i usuwanie wiadomo≈õci
- ‚úÖ Kontrola uprawnie≈Ñ
- ‚úÖ Scalable database design